<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Department Admin Dashboard - Campus Connect</title>
    <link rel="stylesheet" href="common-header.css"> <!-- common-header.css is linked directly -->
    <!-- For icons, add a link to an icon library like Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="department_admin.css">
</head>
<body>
    <header class="header">
        <div class="header-left">
             <img src="images/logo 1.png" alt="Campus Connect Logo" class="logo">
            <div class="brand-name">Campus Connect</div>
        </div>
        <div class="page-title" id="departmentNameTitle">Department Dashboard</div>
        <div class="header-actions">
            <a href="index.html" class="btn-header">Back to Home</a>
            <a href="#" id="logoutButton" class="btn-header btn-header-danger">Logout</a>
        </div>
    </header>

    <nav class="dashboard-nav">
        <ul>
            <li><a href="#announcements-section">Announcements</a></li>
            <li><a href="#research-section">Research Opportunities</a></li>
            <li><a href="#course-updates-section">Course Updates</a></li>
            <li><a href="events_management.html">Manage Events</a></li>
        </ul>
    </nav>

    <main>
        <h1 id="welcomeMessage" style="text-align: center; font-size: 2em; color: var(--color-text-base); margin-bottom: 20px;">Welcome, Admin!</h1>
        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Stats Cards -->
            <div class="dashboard-box stats-card">
                <h2><i class="fas fa-users"></i> Students Following</h2>
                <p class="stat-number" id="followersCount">0</p>
            </div>
            <div class="dashboard-box stats-card">
                <h2><i class="fas fa-calendar-check"></i> Upcoming Events</h2>
                <p class="stat-number" id="eventsCount">0</p>
            </div>
            <div class="dashboard-box stats-card">
                <h2><i class="fas fa-newspaper"></i> News Articles</h2>
                <p class="stat-number" id="articlesCount">0</p>
            </div>
        </div>

        <section class="dashboard-grid">
            <!-- Academic Announcements -->
            <div class="dashboard-box" id="announcements-section">
                <h2>Announcements</h2>
                <ul id="announcementsList"></ul>
                <div class="empty-state" style="display: none;">
                    <div class="empty-state-icon">
                        <i class="fas fa-bullhorn fa-3x"></i>
                    </div>
                    <h3>No Announcements Yet!</h3>
                    <p>It's quiet in here. Share an update with your department.</p>
                </div>
                <a href="create_announcement.html" class="action-button pulse-glow"><i class="fas fa-plus-circle"></i> Create New Announcement</a>
            </div>

            <!-- Research Opportunities -->
            <div class="dashboard-box" id="research-section">
                <h2>Research Opportunities</h2>
                <ul id="opportunitiesList"></ul>
                <div class="empty-state" style="display: none;">
                    <div class="empty-state-icon"><i class="fas fa-flask fa-3x"></i></div>
                    <h3>No Opportunities Posted</h3>
                    <p>Post a new research opportunity to attract student talent.</p>
                </div>
                <a href="create_opportunity.html" class="action-button pulse-glow">
                    <i class="fas fa-plus-circle"></i> Post New Opportunity
                </a>
            </div>

            <!-- Course Updates -->
            <div class="dashboard-box" id="course-updates-section">
                <h2>Course Updates</h2>
                <ul id="courseUpdatesList">
                    <!-- Course updates will be dynamically inserted here -->
                </ul>
                <div class="empty-state" style="display: none;">
                    <div class="empty-state-icon"><i class="fas fa-book-reader fa-3x"></i></div>
                    <h3>No Course Updates</h3>
                    <p>Post updates about courses, materials, or schedules.</p>
                </div>
                <a href="create_course_update.html" class="action-button pulse-glow"><i class="fas fa-plus-circle"></i> Post Course Update</a>
            </div>

            <!-- Events -->
            <div class="dashboard-box" id="events-section">
                <h2>Events</h2>
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-calendar-alt fa-3x"></i></div>
                    <h3>Manage Your Events</h3>
                    <p>Create, edit, and view registrations for all your department's events.</p>
                </div>
                <a href="events_management.html" class="action-button pulse-glow"><i class="fas fa-edit"></i> Manage Events</a>
            </div>
        </section>

    </main>

    <footer>
        <p>&copy; 2024 Campus Connect - Department Admin</p>
    </footer>

    <div class="floating-icons-container">
        <div class="floating-icon icon1"></div>
        <div class="floating-icon icon2"></div>
        <div class="floating-icon icon3"></div>
        <div class="floating-icon icon4"></div>
        <div class="floating-icon icon5"></div>
        <div class="floating-icon icon6"></div>
    </div>

    <script>
        function escapeHTML(str) {
            // A more robust escape function
            if (str === null || str === undefined) return '';
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        function getMockDashboardData(currentUser) {
            // This function provides dummy data for prototyping when the backend is not available.
            // It tries to get the department name from the logged-in user's data for a more realistic feel.
            let departmentName = "Computer Science"; // A default for the prototype

            if (currentUser && currentUser.departmentDetails && currentUser.departmentDetails.name) {
                // If the logged-in user object in localStorage has department details, use them.
                // This makes the prototype feel more real.
                departmentName = currentUser.departmentDetails.name;
                console.log(`Prototype is using department name from localStorage: "${departmentName}"`);
            } else {
                console.warn("Prototype could not find department name in localStorage (currentUser.departmentDetails.name). Using a default name. For a more realistic prototype, ensure the user object in localStorage is complete.");
            }

            return {
                departmentName: departmentName,
                stats: { followers: 123, upcomingEvents: 4, newsArticles: 8 },
                announcements: [{ announcement_id: 1, title: 'Midterm Exam Schedule Released' }, { announcement_id: 2, title: 'Guest Lecture on AI Ethics' }],
                opportunities: [{ opportunity_id: 1, title: 'Research Assistant for ML Project' }, { opportunity_id: 2, title: 'Summer Internship at TechCorp' }],
                courseUpdates: [{ update_id: 1, course_code: 'CS101', title: 'Lecture 5 notes uploaded' }]
            };
        }

        function renderItems(listElement, items, renderItemFunc, emptyStateElement) {
            listElement.innerHTML = '';
            if (items && items.length > 0) {
                emptyStateElement.style.display = 'none';
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = renderItemFunc(item);
                    listElement.appendChild(li);
                });
            } else {
                emptyStateElement.style.display = 'flex';
            }
        }

        function renderAnnouncementItem(item) {
            return `
                <span><i class="fas fa-bullhorn item-icon"></i> ${escapeHTML(item.title)}</span>
                <div class="item-actions">
                    <a href="create_announcement.html?announcementIdToEdit=${item.announcement_id}" class="action-button action-button-secondary"><i class="fas fa-pencil-alt"></i> Edit</a>
                    <button onclick="deleteItem('announcement', ${item.announcement_id})" class="action-button action-button-danger"><i class="fas fa-trash"></i> Delete</button>
                </div>
            `;
        }

        function renderOpportunityItem(item) {
            return `
                <span><i class="fas fa-flask item-icon"></i> ${escapeHTML(item.title)}</span>
                <div class="item-actions">
                    <a href="create_opportunity.html?opportunityIdToEdit=${item.opportunity_id}" class="action-button action-button-secondary"><i class="fas fa-pencil-alt"></i> Edit</a>
                    <button onclick="deleteItem('opportunity', ${item.opportunity_id})" class="action-button action-button-danger"><i class="fas fa-trash"></i> Delete</button>
                </div>
            `;
        }

        function renderCourseUpdateItem(item) {
            return `
                <span><i class="fas fa-book-reader item-icon"></i> <strong>${escapeHTML(item.course_code)}:</strong> ${escapeHTML(item.title)}</span>
                <div class="item-actions">
                    <a href="create_course_update.html?updateIdToEdit=${item.update_id}" class="action-button action-button-secondary"><i class="fas fa-pencil-alt"></i> Edit</a>
                    <button onclick="deleteItem('course_update', ${item.update_id})" class="action-button action-button-danger"><i class="fas fa-trash"></i> Delete</button>
                </div>
            `;
        }

        async function fetchDashboardData() {
            const authToken = localStorage.getItem('authToken');
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            if (!authToken || !currentUser || currentUser.role !== 'department_admin') {
                alert('You are not authorized. Please log in as a Department Admin.');
                window.location.href = '/login-admin';
                return;
            }

            try {
                const response = await fetch('/api/department/dashboard', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch dashboard data. Status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success && result.data) {
                    populateDashboard(result.data, currentUser);
                } else {
                    throw new Error(result.message || 'Failed to parse dashboard data.');
                }
            } catch (error) {
                console.warn('API fetch failed, loading mock data for prototype. Error:', error);
                // --- For Prototyping: Load mock data if API fails ---
                const mockData = getMockDashboardData(currentUser);
                populateDashboard(mockData, currentUser);
            }
        }

        function populateDashboard(data, currentUser) {
            // Personalize page
            document.getElementById('welcomeMessage').textContent = `Welcome, ${escapeHTML(currentUser.firstName)}!`;
            document.getElementById('departmentNameTitle').textContent = `${escapeHTML(data.departmentName)} Dashboard`;

            // Update stats
            document.getElementById('followersCount').textContent = data.stats.followers || 0;
            document.getElementById('eventsCount').textContent = data.stats.upcomingEvents || 0;
            document.getElementById('articlesCount').textContent = data.stats.newsArticles || 0;

            // Render lists
            renderItems(document.getElementById('announcementsList'), data.announcements, renderAnnouncementItem, document.querySelector('#announcements-section .empty-state'));
            renderItems(document.getElementById('opportunitiesList'), data.opportunities, renderOpportunityItem, document.querySelector('#research-section .empty-state'));
            renderItems(document.getElementById('courseUpdatesList'), data.courseUpdates, renderCourseUpdateItem, document.querySelector('#course-updates-section .empty-state'));
        }

        function deleteItem(itemType, itemId) {
            if (confirm(`Are you sure you want to delete this ${itemType.replace('_', ' ')}? This action cannot be undone.`)) {
                const authToken = localStorage.getItem('authToken');
                // Example endpoint, adjust as needed
                const endpoint = `/api/${itemType}s/${itemId}`; 
                
                fetch(endpoint, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert(`${itemType.replace('_', ' ')} deleted successfully.`);
                        fetchDashboardData(); // Refresh the dashboard
                    } else {
                        alert(`Failed to delete: ${result.message}`);
                    }
                })
                .catch(error => {
                    console.error(`Error deleting ${itemType}:`, error);
                    alert('An error occurred while deleting. Please try again.');
                });
            }
        }

        document.getElementById('logoutButton').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            window.location.href = '/welcome.html';
        });

        document.addEventListener('DOMContentLoaded', fetchDashboardData);
    </script>
</body>

</html>